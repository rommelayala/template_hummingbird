name: ğŸ§ª Playwright Tests con Allure

on:
  # Permite ejecuciÃ³n manual desde la UI de GitHub
  workflow_dispatch:
    inputs:
      branch:
        description: 'Rama donde ejecutar los tests'
        required: true
        default: 'main'
        type: string
      test_path:
        description: 'Path de tests especÃ­fico (opcional, ej: tests/test_login.py)'
        required: false
        default: 'tests/'
        type: string
      
  # Opcional: Ejecutar automÃ¡ticamente en push/PR
  # push:
  #   branches: [ main, develop ]
  # pull_request:
  #   branches: [ main ]

jobs:
  test:
    name: Ejecutar Tests E2E
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout del cÃ³digo en la rama especificada
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      
      # 2. Configurar Python
      - name: ğŸ Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. Instalar dependencias Python
      - name: ğŸ“¦ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. Instalar browsers de Playwright
      - name: ğŸŒ Instalar browsers de Playwright
        run: |
          playwright install chromium
          playwright install-deps chromium
      
      # 5. Ejecutar tests con pytest
      - name: ğŸ§ª Ejecutar tests
        run: |
          pytest ${{ github.event.inputs.test_path || 'tests/' }} \
            --alluredir=allure-results \
            --clean-alluredir \
            -v
        continue-on-error: true
      
      # 6. Obtener historial de Allure (para trending)
      - name: ğŸ“Š Obtener historial de Allure
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
      
      # 7. Copiar historial anterior
      - name: ğŸ“ Copiar historial de reportes
        if: always()
        continue-on-error: true
        run: |
          if [ -d "gh-pages/history" ]; then
            mkdir -p allure-results/history
            cp -r gh-pages/history/. allure-results/history/
          fi
      
      # 8. Instalar Allure CLI
      - name: ï¿½ Instalar Allure
        if: always()
        run: |
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
          sudo tar -zxvf allure-2.24.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.24.0/bin/allure /usr/bin/allure
          allure --version
      
      # 9. Generar reporte Allure
      - name: ğŸ“ˆ Generar reporte Allure
        if: always()
        run: |
          allure generate allure-results -o allure-report --clean
          cp -r allure-report/history/. allure-results/history/ || true
      
      # 10. Publicar reporte a GitHub Pages
      - name: ğŸš€ Publicar reporte a GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-report
          keep_files: false
      
      # 11. Subir artifacts (backup)
      - name: ğŸ“ Subir resultados como artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ github.run_number }}
          path: |
            allure-results/
            allure-report/
          retention-days: 30
      
      # 12. Comentar en PR con link al reporte (si es PR)
      - name: ğŸ’¬ Comentar link al reporte
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const reportUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ“Š Reporte Allure Generado\n\nâœ… Los tests se ejecutaron correctamente.\n\nğŸ”— [Ver Reporte Completo](${reportUrl})\n\n_Ejecutado en rama: \`${{ github.event.inputs.branch || github.ref }}\`_`
            })
