name: 游빍 Playwright Tests con Allure

on:
  # Permite ejecuci칩n manual desde la UI de GitHub
  workflow_dispatch:
    inputs:
      branch:
        description: 'Rama donde ejecutar los tests'
        required: true
        default: 'main'
        type: string
      test_path:
        description: 'Path de tests espec칤fico (opcional, ej: tests/test_login.py)'
        required: false
        default: 'tests/'
        type: string

jobs:
  test:
    name: Ejecutar Tests E2E
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout del c칩digo
      - name: 游닌 Checkout c칩digo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      
      # 2. Configurar Python
      - name: 游냀 Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. Instalar dependencias
      - name: 游닍 Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. Instalar browsers
      - name: 游깷 Instalar browsers de Playwright
        run: |
          playwright install chromium
          playwright install-deps chromium
      
      # 5. Ejecutar tests
      - name: 游빍 Ejecutar tests
        run: |
          pytest ${{ github.event.inputs.test_path || 'tests/' }} \
            --alluredir=allure-results \
            --clean-alluredir \
            -v
        continue-on-error: true
      
      # 6. Instalar Allure CLI
      - name: 游댢 Instalar Allure
        if: always()
        run: |
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
          sudo tar -zxvf allure-2.24.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.24.0/bin/allure /usr/bin/allure
          allure --version
      
      # 7. Generar reporte Allure
      - name: 游늳 Generar reporte Allure
        if: always()
        run: |
          allure generate allure-results -o allure-report --clean
      
      # 8. Publicar a GitHub Pages
      - name: 游 Publicar a GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-report
          keep_files: false
